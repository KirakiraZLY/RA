---
title: "SNP extract"
output: html_document
date: "2023-11-21"
---

```{r setup, include=FALSE}
# library(GENESIS)
# library(qqman)
library(tidyverse)
library(tidyr)
library(readr)
library(data.table)
library(stringr)
library(stringi)
```

## Reading icd10 and FinnGen R8 list
```{r}
# snps <- read_table2("R8_manifest.tsv", col_names = FALSE)
icd10 <- read_table2("./icdtraits.details")
finngen <- read_tsv("./R8_manifest.tsv")
```


## Matching
```{r}
icd10_pheno <- data.frame(icd10$Description)
colnames(icd10_pheno) <- c("phenocode")
# icd10_pheno <- separate(icd10_pheno, Description, into = paste0("word_", 1:8), sep = "_", remove = FALSE)
finngen_pheno <- data.frame(finngen$phenocode)
colnames(finngen_pheno) <- c("phenocode")
# finngen_pheno <- separate(finngen_pheno, phenocode, into = paste0("word_", 1:6), sep = "_", remove = FALSE)

finngen_pheno <- finngen_pheno %>%
  mutate_all(tolower)
icd10_pheno <- icd10_pheno %>%
  mutate_all(tolower)
finngen_pheno$Index <- 1:nrow(finngen_pheno)

finngen_pheno$phenocode <- sub(".*?_", "", finngen_pheno$phenocode) ## delete all the chrs before the first "_"
icd10_pheno$phenocode <- sub(".*?_", "", icd10_pheno$phenocode) ## delete all the chrs before the first "_"

################### to make finngen strings into one string without sep "_", and icd10 has "_"
################### So that when matching them, to see if a word in icd10 is totally matched with finngen substring

icd10_pheno$phenocode <- gsub("_", "", icd10_pheno$phenocode)
# icd10_pheno$phenocode <- gsub("_", "", icd10_pheno$phenocode)
finngen_pheno <- separate(finngen_pheno, phenocode, into = paste0("word_", 1:8), sep = "_", remove = FALSE)
finngen_pheno$Index <- 1:nrow(finngen_pheno)
icd10_pheno$Index <- 1:nrow(icd10_pheno)
```

## complete common substring?
```{r}


result <- data.frame(matrix(0, nrow = nrow(finngen_pheno), ncol = 8))
# result <- data.frame(matrix(0, nrow = 10, ncol = 8))


for (i in 1:nrow(finngen_pheno)) {
# for (i in 1:10) {
    for (j in 2:9) {
      for (k in 1:nrow(icd10_pheno)) {
      string1 <- finngen_pheno[i,j]
      string2 <- icd10_pheno$phenocode[k]
      
      # is_substring <- stri_detect_fixed(string2, string1)
      tmp <- ifelse(stri_detect_fixed(string2, string1), 1, 0)
      result[i,j-1] <- max(result[i,j-1], tmp)
      
      # result[,j-1] <- sapply(1:nrow(icd10_pheno), function(i) {
  # stri_detect(df$string2[i], df$string1[i])
# })
      # if (grepl(string1, string2)) {
        # print(i)
      # }
    }
  }
  print(i)
}

result$Index <- 1:nrow(result)

```

## Delete any rows unmatched
```{r}
result_filtered <- result %>% filter_at(vars(1:8), any_vars(. != 0))
write.table(result_filtered,"finngen_subset_in_icd10.txt",row.names = FALSE, col.names = FALSE, quote = FALSE)

```






## Matching Longest Common Sequence
```{r}

find_longest_common_subsequence <- function(str1, str2) { ## LCS
  n <- nchar(str1)
  m <- nchar(str2)
  
  dp <- matrix(0, n + 1, m + 1)
  
  for (i in 1:n) {
    for (j in 1:m) {
      if (substring(str1, i, i) == substring(str2, j, j)) {
        dp[i + 1, j + 1] <- dp[i, j] + 1
      } else {
        dp[i + 1, j + 1] <- max(dp[i, j + 1], dp[i + 1, j])
      }
    }
  }
  
  i <- n
  j <- m
  lcs <- character(0)
  
  while (i > 0 && j > 0) {
    if (substring(str1, i, i) == substring(str2, j, j)) {
      lcs <- c(substring(str1, i, i), lcs)
      i <- i - 1
      j <- j - 1
    } else if (dp[i, j + 1] > dp[i + 1, j]) {
      i <- i - 1
    } else {
      j <- j - 1
    }
  }
  # print(paste(rev(lcs), collapse = ""))
  return(paste(rev(lcs), collapse = ""))
}

result <- data.frame(matrix(0, nrow = nrow(icd10_pheno), ncol = 2))
colnames(result) <- c("LCS", "MaxLength")
for (i in 1:nrow(icd10_pheno)) {
  for (j in 1:nrow(finngen_pheno)) {
    string1 <- icd10_pheno$phenocode[i]
    string2 <- finngen_pheno$phenocode[j]
    print(string1)
    print(string2)
    # output_string <- paste("String1 :", string1)
    # print(output_string)
    # output_string <- paste("String2 :", string2)
    # print(output_string)
    
    tmp <- find_longest_common_subsequence(string1, string2)
    if (nchar(tmp) > result$MaxLength[i]) {
      result$LCS[i] <- tmp
      result$MaxLength[i] <- nchar(tmp)
    }
  }
  print(i)
}


```

